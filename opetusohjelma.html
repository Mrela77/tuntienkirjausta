<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ostolaskujen opetus</title>
<style>
  :root{ --blue:#0A66FF; --black:#000; --line:#e5e7eb; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica; background:#fff; color:#111; }
  header{ display:flex; align-items:center; gap:10px; background:var(--blue); color:#fff; padding:14px 16px; }
  header .brand{ font-size:20px; font-weight:800; text-shadow:1px 1px var(--black) }
  .wrap{ padding:18px; max-width:980px; margin:0 auto; }
  .card{ border:1px solid var(--black); border-radius:16px; padding:16px; background:#fff; margin-bottom:14px }
  label{ display:block; margin:6px 0 6px; font-weight:700; }
  input,textarea,button,select{ width:100%; border:1px solid var(--black); border-radius:12px; padding:12px; font-size:16px; background:#fff; }
  textarea{ min-height:160px }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  @media (max-width:820px){ .row{ grid-template-columns:1fr } }
  .btnrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
  .btn{ padding:12px 14px; font-weight:800; border-radius:12px; cursor:pointer; }
  .primary{ background:var(--blue); color:#fff; text-shadow:1px 1px var(--black) }
  .secondary{ background:#F4F6FA; color:#0A66FF }
  .danger{ background:#fff0f0; color:#b00020; border-color:#b00020 }
  .muted{ color:#6b7280; font-size:12px; margin-top:6px }
  code.k{ background:#F3F4F6; padding:2px 6px; border-radius:6px; border:1px solid #E5E7EB }
  .pill{ display:inline-block; padding:3px 10px; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; background:#fff }
  table{ width:100%; border-collapse:collapse; }
  th,td{ border-bottom:1px solid #e5e7eb; padding:8px 10px; text-align:left; }
  th{ background:#F9FAFB; position:sticky; top:0; z-index:1 }
  .right{ text-align:right }
  .hint{ font-size:12px; color:#374151; margin-top:6px }
</style>
</head>
<body>
  <header>
    <div class="brand">Ostolaskujen opetus</div>
  </header>

  <div class="wrap">
    <!-- 1) Esimerkkiteksti -->
    <div class="card">
      <h3 style="margin:0 0 8px">1) Liitä ostolaskun raakateksti</h3>

      <div class="row">
        <div>
          <label>Raakateksti (voit myös poimia suoraan PDF:stä alapuolelta)
            <textarea id="sample" placeholder="Liitä tähän laskun tekstisisältö (voit avata PDF:n ja kopioida tekstit)."></textarea>
          </label>
          <div class="hint">Vinkki: Usein riittää 1–3 ensimmäistä sivua. PDF-poiminta lukee ne automaattisesti.</div>
        </div>
        <div>
          <label>PDF-tiedosto(t) (valinnainen)
            <input id="pdfInput" type="file" accept="application/pdf" multiple>
          </label>
          <div class="btnrow">
            <button type="button" class="btn secondary" id="pickTextBtn" disabled>Poimi teksti PDF:stä</button>
            <span class="pill" id="pdfMeta">Ei valintoja</span>
          </div>
          <div class="muted" id="pdfHint">Lataan PDF-lukijan…</div>
        </div>
      </div>
    </div>

    <!-- 2) Sääntö -->
    <div class="card">
      <h3 style="margin:0 0 8px">2) Määritä säännöt</h3>
      <div class="row">
        <div>
          <label>Säännön nimi (esim. "Sähkö Oy")<input id="ruleName" placeholder="Nimi raportointiin ja tunnistukseen"></label>
        </div>
        <div>
          <label>Toimittajan tunnistus (RegExp)
            <input id="supplierPattern" placeholder="Esim: ^\\s*SÄHKÖ OY\\b">
          </label>
          <div class="muted">Käytetään päätellen, että sääntö sopii tähän laskuun. Jätä tyhjäksi, jos et tarvitse.</div>
        </div>
      </div>

      <div class="row">
        <div><label>Toimittaja (RegExp, ryhmä 1)<input id="re_supplier" placeholder="Esim: Toimittaja\\s*[:\\-]\\s*(.+)"></label></div>
        <div><label>Laskun numero (RegExp, ryhmä 1)<input id="re_invno" placeholder="Esim: Laskun(?:numero| nro)\\s*[:#]?\\s*([A-Za-z0-9\\-\\/]+)"></label></div>
      </div>
      <div class="row">
        <div><label>Laskun pvm (RegExp, ryhmä 1)<input id="re_invdate" placeholder="Esim: (?:Laskun\\s*pvm|Päiväys|Pvm)\\s*[:#]?\\s*(\\d{1,2}\\.\\d{1,2}\\.\\d{2,4})"></label></div>
        <div><label>Eräpäivä (RegExp, ryhmä 1)<input id="re_duedate" placeholder="Esim: (?:Eräpäivä|Eräpvm)\\s*[:#]?\\s*(\\d{1,2}\\.\\d{1,2}\\.\\d{2,4})"></label></div>
      </div>
      <div class="row">
        <div><label>Summa (RegExp, ryhmä 1) €<input id="re_total" placeholder="Esim: (?:Yhteensä|Loppusumma|Summa)\\s*[:#]?\\s*([0-9\\.,\\s]+)"></label></div>
        <div><label>Maksettava (RegExp, ryhmä 1) €<input id="re_payable" placeholder="Esim: (?:Maksettavaa|Maksetaan)\\s*[:#]?\\s*([0-9\\.,\\s]+)"></label></div>
      </div>

      <div class="btnrow">
        <button type="button" class="btn secondary" id="testBtn">Testaa</button>
        <button type="button" class="btn primary" id="saveBtn">Tallenna sääntö</button>
      </div>
    </div>

    <!-- 3) Testitulokset -->
    <div class="card">
      <h3 style="margin:0 0 8px">3) Testitulokset</h3>
      <table>
        <thead><tr><th>Kenttä</th><th>Tulos</th></tr></thead>
        <tbody id="testOut"></tbody>
      </table>
      <div class="muted">Hyvä sääntö tuottaa vähintään kaksi keskeistä osumaa (esim. Laskunro + summa tai pvm).</div>
    </div>

    <!-- 4) Tallennetut säännöt -->
    <div class="card">
      <h3 style="margin:0 0 8px">Tallennetut säännöt</h3>
      <table id="rulesTbl">
        <thead><tr><th>Nimi</th><th>Toimittajan tunnistus</th><th>Poista</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="btnrow">
        <button type="button" class="btn secondary" id="backBtn">Takaisin tuontiin</button>
      </div>
      <div class="muted">Säännöt tallennetaan localStorage-avain: <code>ostolasku_rules_v1</code>. Ne ovat heti käytössä sivulla <code>ostolaskujen-ajo.html</code>.</div>
    </div>
  </div>

<script>
(function(){
  const RULES_KEY='ostolasku_rules_v1';
  const $=id=>document.getElementById(id);
  const getVal=id=>$(id).value||'';
  const toFloatFI=s=>{ if(!s) return NaN; s=String(s).replace(/\s+/g,'').replace(/\./g,'').replace(',', '.'); const n=parseFloat(s); return isNaN(n)?NaN:n; };

  /* ---------- PDF.js lataus, joka toimii myös file:// / content:// ---------- */
  const PDF_VER = '4.7.76';
  const PDF_MAIN = `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDF_VER}/legacy/build/pdf.min.js`;
  const PDF_WORKER = `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDF_VER}/legacy/build/pdf.worker.min.js`;

  const pickBtn = $('pickTextBtn');
  const pdfHint = $('pdfHint');

  function injectScript(src){
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script'); s.src=src; s.async=true;
      s.onload=()=>resolve();
      s.onerror=()=>reject(new Error('Script load failed: '+src));
      document.head.appendChild(s);
    });
  }

  async function ensurePdfJs(){
    if(window.pdfjsLib){ return true; }
    try{
      await injectScript(PDF_MAIN);
      if(window.pdfjsLib){
        try{ window.pdfjsLib.GlobalWorkerOptions.workerSrc = PDF_WORKER; }catch(_){}
        return true;
      }
    }catch(e){
      console.warn(e);
    }
    return false;
  }

  async function initPdf(){
    const ok = await ensurePdfJs();
    if(ok){
      pickBtn.disabled = false;
      pdfHint.textContent = 'PDF-lukija valmis.';
    }else{
      pickBtn.disabled = false; // sallitaan silti, mutta ilmoitetaan virhe painalluksessa
      pdfHint.textContent = 'PDF.js ei saatavilla (offline?). Voit silti liittää tekstin käsin.';
    }
  }

  // käynnistä lataus heti
  initPdf();

  async function extractTextFromPdf(file, maxPages=3){
    if(!window.pdfjsLib) throw new Error('PDF.js ei ole käytettävissä');
    const buf=await file.arrayBuffer();
    const pdf=await window.pdfjsLib.getDocument({data:buf}).promise;
    let text=''; const pages=Math.min(maxPages, pdf.numPages);
    for(let i=1;i<=pages;i++){
      const p=await pdf.getPage(i);
      const tc=await p.getTextContent();
      text+=tc.items.map(it=>it.str).join(' ')+'\n';
    }
    return text.trim();
  }

  $('pdfInput').addEventListener('change',()=>{
    const n = $('pdfInput').files?.length || 0;
    $('pdfMeta').textContent = n ? `Valittu: ${n} PDF` + (n>1?'t':'') : 'Ei valintoja';
  });

  pickBtn.addEventListener('click', async ()=>{
    const files = Array.from($('pdfInput').files||[]);
    if(!files.length){ alert('Valitse ensin PDF-tiedosto(t).'); return; }
    try{
      let out = $('sample').value || '';
      for(const f of files){
        try{
          const t = await extractTextFromPdf(f, 3);
          out += (out ? '\n\n' : '') + `--- ${f.name} ---\n` + (t||'[ei tekstiä]');
        }catch(err){
          out += (out ? '\n\n' : '') + `--- ${f.name}: Luku epäonnistui (${err && err.message ? err.message : err}) ---`;
        }
      }
      $('sample').value = out;
      alert('Teksti poimittu PDF:stä.');
    }catch(e){
      alert('PDF-poiminta ei onnistu: ' + (e && e.message ? e.message : e));
    }
  });

  /* ---------- Säännöt ---------- */
  function loadRules(){ try{ return JSON.parse(localStorage.getItem(RULES_KEY)||'[]'); }catch(_){ return []; } }
  function saveRules(arr){ localStorage.setItem(RULES_KEY, JSON.stringify(arr||[])); }
  function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }

  function renderRules(){
    const rules=loadRules();
    const tb=document.querySelector('#rulesTbl tbody'); tb.innerHTML='';
    rules.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${(r.name||'').replace(/</g,'&lt;')}</td>
        <td><code class="k">${(r.supplierPattern||'').replace(/</g,'&lt;')}</code></td>
        <td><button type="button" class="btn danger" data-idx="${i}" data-act="del">Poista</button></td>
      `;
      tb.appendChild(tr);
    });
  }

  function testRule(){
    const txt = $('sample').value||'';
    const outBody = $('testOut'); outBody.innerHTML='';
    function one(label, re){
      let v='';
      try{ if(re){ const m=txt.match(new RegExp(re,'i')); if(m) v=(m[1]||m[0]||'').toString().trim(); } }
      catch(_){ v='[virhe regexissä]'; }
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${label}</td><td>${(v||'').replace(/</g,'&lt;')}</td>`; outBody.appendChild(tr);
      return v;
    }
    const total = one('Summa €', getVal('re_total'));
    const payable = one('Maksettava €', getVal('re_payable'));
    if(total){ const tr=document.createElement('tr'); tr.innerHTML=`<td>Summa (numerona)</td><td>${(isNaN(toFloatFI(total))?'—':toFloatFI(total))}</td>`; outBody.appendChild(tr); }
    if(payable){ const tr=document.createElement('tr'); tr.innerHTML=`<td>Maksettava (numerona)</td><td>${(isNaN(toFloatFI(payable))?'—':toFloatFI(payable))}</td>`; outBody.appendChild(tr); }
    one('Toimittaja', getVal('re_supplier'));
    one('Laskunro', getVal('re_invno'));
    one('Laskun pvm', getVal('re_invdate'));
    one('Eräpäivä', getVal('re_duedate'));
  }

  function saveRule(){
    const r={
      id:uid(),
      name:getVal('ruleName').trim(),
      supplierPattern:getVal('supplierPattern').trim(),
      fields:{
        supplier:{regex:getVal('re_supplier'),flags:'i'},
        invno:{regex:getVal('re_invno'),flags:'i'},
        invdate:{regex:getVal('re_invdate'),flags:'i'},
        duedate:{regex:getVal('re_duedate'),flags:'i'},
        total:{regex:getVal('re_total'),flags:'i'},
        payable:{regex:getVal('re_payable'),flags:'i'}
      }
    };
    if(!r.name){ alert('Anna säännölle nimi.'); return; }
    const all=loadRules(); all.unshift(r); saveRules(all);
    alert('Sääntö tallennettu.');
    renderRules();
  }

  document.getElementById('rulesTbl').addEventListener('click',(e)=>{
    const idx=e.target?.dataset?.idx;
    if(e.target?.dataset?.act==='del' && idx!=null){
      const all=loadRules(); all.splice(Number(idx),1); saveRules(all); renderRules();
    }
  });

  document.getElementById('testBtn').addEventListener('click', testRule);
  document.getElementById('saveBtn').addEventListener('click', saveRule);
  document.getElementById('backBtn').addEventListener('click', ()=>{
    const base = location.href.slice(0, location.href.lastIndexOf('/') + 1);
    location.href = base + 'ostolaskujen-ajo.html?cb=' + Date.now();
  });

  // Hyvät oletus-regexit
  if(!$('re_invno').value) $('re_invno').value = 'Laskun?\\s*(?:numero|nro|no)\\s*[:#]?\\s*([A-Za-z0-9\\-\\/]+)';
  if(!$('re_invdate').value) $('re_invdate').value = '(?:Laskun\\s*pvm|Päiväys|Pvm)\\s*[:#]?\\s*(\\d{1,2}\\.\\d{1,2}\\.\\d{2,4})';
  if(!$('re_duedate').value) $('re_duedate').value = '(?:Eräpäivä|Eräpvm)\\s*[:#]?\\s*(\\d{1,2}\\.\\d{1,2}\\.\\d{2,4})';
  if(!$('re_total').value) $('re_total').value = '(?:Yhteensä|Loppusumma|Summa)\\s*[:#]?\\s*([0-9\\.,\\s]+)\\s*€?';
  if(!$('re_payable').value) $('re_payable').value = '(?:Maksettavaa|Maksetaan)\\s*[:#]?\\s*([0-9\\.,\\s]+)\\s*€?';

  renderRules();
})();
</script>
</body>
</html>