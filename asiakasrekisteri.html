<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Estä välimuisti -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Asiakasrekisteri</title>
<style>
  :root{ --blue:#0A66FF; --black:#000; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica; background:#fff; color:#111; }
  header{ background:var(--blue); color:#fff; padding:12px 16px; font-weight:800; text-shadow:1px 1px var(--black) }
  .wrap{ padding:18px; max-width:900px; margin:0 auto; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  @media (max-width:680px){ .row{ grid-template-columns:1fr } }
  label{ display:block; margin:10px 0 6px; color:var(--blue); font-weight:700; text-shadow:1px 1px var(--black); }
  input{ width:100%; border:1px solid var(--black); border-radius:12px; padding:12px; font-size:16px; background:#fff; }
  .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px }
  button{ padding:12px 14px; font-size:16px; border-radius:12px; border:1px solid var(--black); cursor:pointer; font-weight:800 }
  .primary{ background:var(--blue); color:#fff; text-shadow:1px 1px var(--black) }
  .secondary{ background:#F7F7F7; color:var(--blue) }
  .muted{ color:#6b7280; font-size:12px; margin-top:6px }
  table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:16px; }
  th, td{ text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb; }
  th{ color:var(--blue); text-shadow:1px 1px var(--black) }
  .actions button{ margin-right:6px }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px }
  .pill{ border:1px solid var(--black); border-radius:999px; padding:6px 10px; font-size:12px; color:#333 }
</style>
</head>
<body>
<header>Asiakasrekisteri</header>
<div class="wrap">
  <!-- Lomake -->
  <div class="row">
    <div>
      <label for="nimi">Nimi</label>
      <input id="nimi" type="text" placeholder="Etunimi Sukunimi / Yritys Oy" />
    </div>
    <div>
      <label for="hetu">Henkilötunnus</label>
      <input id="hetu" type="text" placeholder="010101-123A" />
    </div>
  </div>

  <label for="osoite">Osoite</label>
  <input id="osoite" type="text" placeholder="Katu 1" />

  <div class="row">
    <div>
      <label for="posti">Postinumero</label>
      <input id="posti" type="text" placeholder="00100" />
    </div>
    <div>
      <label for="kaupunki">Kaupunki / kunta</label>
      <input id="kaupunki" type="text" placeholder="Helsinki" />
    </div>
  </div>

  <div class="row">
    <div>
      <label for="puh">Puhelin</label>
      <input id="puh" type="tel" placeholder="040 123 4567" />
    </div>
    <div>
      <label for="email">Sähköposti</label>
      <input id="email" type="email" placeholder="etunimi.sukunimi@domain.fi" />
    </div>
  </div>

  <div class="btns">
    <button class="primary" id="saveBtn">Tallenna / Päivitä</button>
    <button class="secondary" id="clearBtn">Tyhjennä lomake</button>
  </div>

  <div class="toolbar">
    <input id="search" type="search" placeholder="Haku nimen / osoitteen mukaan" style="flex:1; border:1px solid var(--black); border-radius:12px; padding:10px 12px; font-size:16px;">
    <span class="pill" id="countPill">0 asiakasta</span>
  </div>

  <!-- Lista -->
  <table>
    <thead>
      <tr>
        <th>Nimi</th><th>HETU</th><th>Osoite</th><th>Posti</th><th>Kaupunki</th><th>Puhelin</th><th>Sähköposti</th><th>Toiminnot</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="muted">Tallennus paikallisesti (localStorage: <code>asiakasrekisteri_lista</code>).</div>
</div>

<script>
(function(){
  const LS = 'asiakasrekisteri_lista';
  function $(id){ return document.getElementById(id); }

  function load(){ try{ return JSON.parse(localStorage.getItem(LS)||'[]'); }catch(_){ return []; } }
  function save(arr){ localStorage.setItem(LS, JSON.stringify(arr)); }

  function readForm(){
    return {
      id: currentId || ('c_'+Date.now()+'_'+Math.random().toString(36).slice(2,7)),
      nimi: $('nimi').value.trim(),
      hetu: $('hetu').value.trim(),
      osoite: $('osoite').value.trim(),
      posti: $('posti').value.trim(),
      kaupunki: $('kaupunki').value.trim(),
      puh: $('puh').value.trim(),
      email: $('email').value.trim()
    };
  }

  function writeForm(o){
    $('nimi').value=o.nimi||'';
    $('hetu').value=o.hetu||'';
    $('osoite').value=o.osoite||'';
    $('posti').value=o.posti||'';
    $('kaupunki').value=o.kaupunki||'';
    $('puh').value=o.puh||'';
    $('email').value=o.email||'';
  }

  function clearForm(){ currentId=null; writeForm({}); }

  function render(){
    const q = $('search').value.trim().toLowerCase();
    const list = load();
    const filtered = q ? list.filter(x =>
      (x.nimi||'').toLowerCase().includes(q) ||
      (x.osoite||'').toLowerCase().includes(q) ||
      (x.kaupunki||'').toLowerCase().includes(q)
    ) : list;

    const tb = $('tbody');
    tb.innerHTML = '';
    filtered.forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(row.nimi)}</td>
        <td>${escapeHtml(row.hetu)}</td>
        <td>${escapeHtml(row.osoite)}</td>
        <td>${escapeHtml(row.posti)}</td>
        <td>${escapeHtml(row.kaupunki)}</td>
        <td>${escapeHtml(row.puh)}</td>
        <td>${escapeHtml(row.email)}</td>
        <td class="actions">
          <button data-act="edit" data-id="${row.id}">Muokkaa</button>
          <button data-act="del" data-id="${row.id}" style="background:#FFE6E6;color:#E11D48;border-color:#E11D48">Poista</button>
        </td>`;
      tb.appendChild(tr);
    });
    $('countPill').textContent = (filtered.length)+' asiakasta';

    tb.querySelectorAll('button[data-act]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        if(act==='edit'){
          const obj = load().find(x=>x.id===id);
          if(obj){ currentId = obj.id; writeForm(obj); window.scrollTo({top:0, behavior:'smooth'}); }
        }else if(act==='del'){
          if(confirm('Poistetaanko asiakas?')){
            const after = load().filter(x=>x.id!==id);
            save(after); render();
          }
        }
      });
    });
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  let currentId = null;

  document.getElementById('saveBtn').addEventListener('click', ()=>{
    const obj = readForm();
    if(!obj.nimi){ alert('Nimi vaaditaan.'); return; }
    const list = load();
    const idx = list.findIndex(x=>x.id===obj.id);
    if(idx>=0) list[idx]=obj; else list.push(obj);
    save(list);
    render();
    alert('Tallennettu.');
  });
  document.getElementById('clearBtn').addEventListener('click', clearForm);
  document.getElementById('search').addEventListener('input', render);

  // Init
  render();
})();
</script>
<!-- SULJE-napin yleiskoodi: lisää tämä ennen </body> -->
<script>
(function(){
  // Etusivu johon palataan tarvittaessa
  const HOME = 'yritys.html';

  function safeClose(){
    // Onko avattu app/ikkuna-tilassa tai window.open:lla?
    const isStandalone = (window.matchMedia &&
      (window.matchMedia('(display-mode: standalone)').matches ||
       window.matchMedia('(display-mode: minimal-ui)').matches));

    if (window.opener || window.name || isStandalone) {
      try { window.close(); return; } catch(_) {}
    }
    // Onko selaushistoriaa? Palaa taakse
    if (history.length > 1) { history.back(); return; }

    // Viimeinen vaihtoehto: siirry etusivulle
    const base = location.href.slice(0, location.href.lastIndexOf('/') + 1);
    const url  = base + HOME + (HOME.includes('?') ? '&' : '?') + 'cb=' + Date.now();
    location.href = url;
  }

  function attachCloseButtons(){
    // Kiinnitä olemassa oleviin sulkunappeihin, jos niitä on:
    const targets = document.querySelectorAll('[data-action="close"], .btn-close, #btnClose, #closeBtn');
    if (targets.length) {
      targets.forEach(el => el.addEventListener('click', safeClose));
      return;
    }

    // Muussa tapauksessa LISÄÄ napin automaattisesti
    const btn = document.createElement('button');
    btn.textContent = 'Sulje';
    btn.setAttribute('data-action', 'close');

    // Käytä sivun omia luokkia jos ne löytyvät, muuten kevyt inlinet
    const hasBtn = !!document.querySelector('.btn');
    const hasSecondary = !!document.querySelector('.btn-secondary');
    if (hasBtn) btn.classList.add('btn');
    if (hasSecondary) btn.classList.add('btn-secondary');
    if (!hasBtn && !hasSecondary) {
      btn.style.cssText =
        'width:100%;padding:12px;margin:12px 0;font-size:16px;'+
        'border-radius:12px;border:1px solid #000;background:#F7F7F7;color:#0A66FF;font-weight:800;cursor:pointer;';
    }

    // Sijoitus: preferoi .wrap, muuten body
    (document.querySelector('.wrap') || document.body).appendChild(btn);
    btn.addEventListener('click', safeClose);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachCloseButtons);
  } else {
    attachCloseButtons();
  }
})();
</script>
<script>
/* ===== Portaalin teema: luku & live-päivitys (kaikki muut sivut) ===== */
(function applySavedTheme(){
  const THEME_KEY='portal_theme_v1';
  function apply(vars){
    const root=document.documentElement;
    if(!vars) return;
    for(const k in vars){ root.style.setProperty(k, vars[k]); }
    root.style.setProperty('--bg',  vars['--bg']  || '#fff');
    root.style.setProperty('--text',vars['--text']|| '#111');
  }
  try{
    const saved = JSON.parse(localStorage.getItem(THEME_KEY) || 'null');
    if(saved) apply(saved);
  }catch(_){}

  // Päivitä live, jos väri muuttuu yrityksen-tiedot-sivulla
  window.addEventListener('storage', (e)=>{
    if(e.key===THEME_KEY || e.key==='__theme_ping'){
      try{ const t = JSON.parse(localStorage.getItem(THEME_KEY)||'null'); if(t) apply(t); }catch(_){}
    }
  });
})();
</script>
</body>
</html>