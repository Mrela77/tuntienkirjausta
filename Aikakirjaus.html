<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Aikakirjaus → Tunnit.xlsx (yhteinen puskuri)</title>
  <style>
    :root{ --blue:#0A66FF; --black:#000; }
    *{ box-sizing:border-box }
    body{ margin:0; padding:16px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica; background:#fff; color:#111; }
    h1{ margin:0 0 12px; color:var(--blue); text-shadow:1px 1px var(--black); font-size:24px; }
    label{ display:block; margin:10px 0 6px; color:var(--blue); font-weight:700; text-shadow:1px 1px var(--black); }
    input,button,select{ width:100%; border:1px solid var(--black); border-radius:12px; padding:12px; font-size:16px; background:#fff; }
    input[type="date"]{ padding:10px 12px }
    .row{ display:grid; grid-template-columns:1fr; gap:10px }
    @media(min-width:560px){ .row-2{ grid-template-columns:1fr 1fr } }
    .btn{ margin:6px 0; padding:14px; border:1px solid var(--black); border-radius:14px; font-weight:700; cursor:pointer; }
    .btn-primary{ background:var(--blue); color:#fff; text-shadow:1px 1px var(--black) }
    .btn-secondary{ background:#F7F7F7; color:var(--blue) }
    .muted{ color:#555; font-size:12px }
    .stats{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:8px 0 4px }
    .stat{ border:1px solid var(--black); border-radius:12px; padding:10px; text-align:center; }
    .stat b{ display:block; font-size:20px; margin-top:2px; color:var(--blue); text-shadow:1px 1px var(--black) }
    #debug{ font-size:12px; color:#B91C1C; margin:4px 0 0 }
  </style>
</head>
<body>
  <h1>Aikakirjaus</h1>

  <div class="row row-2">
    <div>
      <label for="date">Päivämäärä</label>
      <input id="date" type="date" />
    </div>
    <div>
      <label for="customer">Asiakas</label>
      <input id="customer" type="text" placeholder="Asiakkaan nimi" list="customersList" autocomplete="off" />
      <datalist id="customersList"></datalist>
    </div>
  </div>

  <div class="row row-2">
    <div>
      <label for="emp1">Työntekijä</label>
      <input id="emp1" type="text" placeholder="Nimi" list="employeesList" autocomplete="off" />
      <datalist id="employeesList"></datalist>
    </div>
    <div>
      <label for="note">Huomio (valinnainen)</label>
      <input id="note" type="text" placeholder="Kuvaus / tehtävä" />
    </div>
  </div>

  <div class="stats">
    <div class="stat">Tilanne <b id="stateTxt">Valmis</b></div>
    <div class="stat">Käynnissä oleva aika <b id="timerTxt">00:00:00</b></div>
  </div>

  <button type="button" class="btn btn-primary" id="startBtn">Aloita</button>
  <button type="button" class="btn btn-secondary" id="pauseBtn" disabled>Tauko</button>
  <button type="button" class="btn btn-secondary" id="resumeBtn" disabled>Jatka</button>
  <button type="button" class="btn btn-secondary" id="stopBtn" disabled>Lopeta & tallenna</button>

  <div class="spacer"></div>
  <button type="button" class="btn btn-secondary" id="exportXlsxBtn">Tallenna Tunnit.xlsx (vain uudet)</button>

  <div id="debug" class="muted">(debug: odottaa käynnistystä)</div>

<script>
/* ===== Yhteiset avaimet Tuntikirjauksen kanssa ===== */
var storeKey = 'tuntikirjaus_entries_v1';
var custKey  = 'tuntikirjaus_customers_v1';
var empKey   = 'tuntikirjaus_employees_v1';

/* ===== Apurit ===== */
function $(id){ return document.getElementById(id); }
function pad(n){ return (n<10?'0':'')+n; }
function todayStr(){ var d=new Date(); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
function toNumberLike(t){ if(t==null||t==='')return null; var n=parseFloat(String(t).replace(',','.')); return isNaN(n)?null:n; }
function setDebug(msg){ var d=$('debug'); if(d) d.textContent = msg || ''; }
function load(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch(e){ return []; } }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
function upsert(listKey, name){
  if(name==null) return; name=String(name).trim(); if(!name) return;
  var arr=load(listKey)||[]; var k=name.toLowerCase();
  for(var i=0;i<arr.length;i++){ if(String(arr[i]).toLowerCase()===k) return; }
  arr.push(name); arr.sort(); save(listKey,arr);
}
function fillDatalists(){
  function norm(a){ var o=[],s={}; for(var i=0;i<a.length;i++){ var v=a[i]; if(v==null)continue; v=String(v).trim(); if(!v)continue; var k=v.toLowerCase(); if(!s[k]){s[k]=1;o.push(v);} } return o; }
  var cust=norm(load(custKey)||[]), emps=norm(load(empKey)||[]);
  save(custKey,cust); save(empKey,emps);
  var c=$('customersList'), e=$('employeesList'), i, h='';
  h=''; for(i=0;i<cust.length;i++) h+='<option value="'+cust[i].replace(/"/g,'&quot;')+'"></option>'; if(c) c.innerHTML=h;
  h=''; for(i=0;i<emps.length;i++) h+='<option value="'+emps[i].replace(/"/g,'&quot;')+'"></option>'; if(e) e.innerHTML=h;
}

/* ===== Ajastin ===== */
let running = false;
let paused  = false;
let startEpoch = 0;      // ms
let pauseEpoch = 0;      // ms, kun tauko alkaa
let accruedMs  = 0;      // kertynyt aika ms
let tickTimer  = null;

function updateTimerView(){
  let ms = accruedMs + (running && !paused ? (Date.now() - startEpoch) : 0);
  if(ms < 0) ms = 0;
  const h = Math.floor(ms/3600000);
  const m = Math.floor((ms%3600000)/60000);
  const s = Math.floor((ms%60000)/1000);
  $('timerTxt').textContent = pad(h)+':'+pad(m)+':'+pad(s);
}

function setState(txt){
  $('stateTxt').textContent = txt;
}

/* ===== UI-napit ===== */
function setButtons(){
  $('startBtn').disabled  = running;                    // ei voi aloittaa uudelleen
  $('pauseBtn').disabled  = !running || paused;         // tauko vain käynnissä
  $('resumeBtn').disabled = !running || !paused;        // jatka vain tauolla
  $('stopBtn').disabled   = !running;                   // lopetus kun käynnissä
}

/* ===== Kirjauksen elinkaari ===== */
function start(){
  const customer = $('customer').value.trim();
  const emp1 = $('emp1').value.trim();
  if(!customer){ alert('Syötä asiakas ennen aloittamista.'); return; }
  if(!emp1){ alert('Syötä työntekijän nimi.'); return; }

  running=true; paused=false; startEpoch=Date.now(); accruedMs=0;
  setState('Käynnissä');
  setButtons();
  if(tickTimer) clearInterval(tickTimer);
  tickTimer = setInterval(updateTimerView, 500);

  upsert(custKey, customer);
  upsert(empKey, emp1);
  fillDatalists();
}

function pause(){
  if(!running || paused) return;
  paused = true;
  pauseEpoch = Date.now();
  accruedMs += (pauseEpoch - startEpoch);
  setState('Tauko');
  setButtons();
  updateTimerView();
}

function resumeTimer(){
  if(!running || !paused) return;
  paused = false;
  startEpoch = Date.now();
  setState('Käynnissä');
  setButtons();
}

function stopAndSave(){
  if(!running) return;
  if(paused === false){
    // lisää vielä juokseva osuus
    accruedMs += (Date.now() - startEpoch);
  }
  running=false; paused=false;
  if(tickTimer){ clearInterval(tickTimer); tickTimer=null; }
  updateTimerView();
  setButtons();
  setState('Valmis');

  // Muunna tunnit desimaaliksi (2 des.)
  const hours = Math.round((accruedMs/3600000)*100)/100;

  const date = $('date').value || todayStr();
  const customer = $('customer').value.trim();
  const emp1 = $('emp1').value.trim();
  const note = $('note').value.trim();

  if(hours <= 0){ alert('Aikaa ei kertynyt.'); return; }

  // Yhteensopiva rivi Tuntikirjauksen kanssa + HUOMIO erillisenä kenttänä
  const item = {
    id:'id_'+Date.now()+'_'+Math.random().toString(36).slice(2,7),
    date: date,
    customer: customer,
    note: note,               // ← TALLENNETAAN OMAAN KENTTÄÄN
    emp1: emp1,
    emp2: '',
    hours1: hours,
    hours2: null,
    logged1_at: todayStr(),
    logged2_at: null,
    created_at: todayStr(),
    updated_at: todayStr(),
    exported_at: null
  };
  const items = load(storeKey) || [];
  items.push(item);
  save(storeKey, items);

  alert('Tallennettu puskuriin: '+hours.toFixed(2)+' h');
}

/* ===== XLSX-vienti — sama formaatti kuin Tuntikirjauksessa + HUOMIO-sarake ===== */
function xmlEscape(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;'); }
function utf8enc(str){ if(window.TextEncoder){ return new TextEncoder().encode(str); } var out=[],i,c; for(i=0;i<str.length;i++){ c=str.charCodeAt(i); if(c<128) out.push(c); else if(c<2048){ out.push(192|(c>>6),128|(c&63)); } else if((c&0xFC00)==0xD800&&i+1<str.length&&(str.charCodeAt(i+1)&0xFC00)==0xDC00){ c=0x10000+((c&0x3FF)<<10)+(str.charCodeAt(++i)&0x3FF); out.push(240|(c>>18),128|((c>>12)&63),128|((c>>6)&63),128|(c&63)); } else { out.push(224|(c>>12),128|((c>>6)&63),128|(c&63)); } } return new Uint8Array(out); }
function u16le(n){ return new Uint8Array([n&255,(n>>8)&255]); }
function u32le(n){ return new Uint8Array([n&255,(n>>8)&255,(n>>16)&255,(n>>24)&255]); }
var CRC_TABLE=(function(){var t=[],i,k,c;for(i=0;i<256;i++){c=i;for(k=0;k<8;k++){c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1);}t[i]=c>>>0;}return t;})();
function crc32(bytes){ var c=~0>>>0,i; for(i=0;i<bytes.length;i++){ c=(c>>>8)^CRC_TABLE[(c^bytes[i])&255]; } return (~c)>>>0; }
function dosTimeDate(d){ var t=d||new Date(); var time=((t.getHours()<<11)|(t.getMinutes()<<5)|((t.getSeconds()/2)|0))>>>0; var date=(((t.getFullYear()-1980)<<9)|((t.getMonth()+1)<<5)|t.getDate())>>>0; return {time:time,date:date}; }
function concat(arrs){ var len=0,i; for(i=0;i<arrs.length;i++) len+=arrs[i].length; var out=new Uint8Array(len),off=0; for(i=0;i<arrs.length;i++){ out.set(arrs[i],off); off+=arrs[i].length; } return out; }
function makeZip(files){ var chunks=[],central=[],offset=0,dd=dosTimeDate(new Date()),i; for(i=0;i<files.length;i++){ var nameBytes=utf8enc(files[i].name); var data=files[i].data; var crc=crc32(data); var comp=data; var local=concat([ u32le(0x04034b50), u16le(20), u16le(0), u16le(0), u16le(dd.time), u16le(dd.date), u32le(crc), u32le(comp.length>>>0), u32le(data.length>>>0), u16le(nameBytes.length), u16le(0), nameBytes, comp ]); chunks.push(local); var centralHdr=concat([ u32le(0x02014b50), u16le(20), u16le(20), u16le(0), u16le(0), u16le(dd.time), u16le(dd.date), u32le(crc), u32le(comp.length>>>0), u32le(data.length>>>0), u16le(nameBytes.length), u16le(0), u16le(0), u16le(0), u16le(0), u32le(0), u32le(offset>>>0), nameBytes ]); central.push(centralHdr); offset += local.length; } var centralBlob=concat(central); var partsBlob=concat(chunks); var end=concat([ u32le(0x06054b50), u16le(0), u16le(0), u16le(files.length), u16le(files.length), u32le(centralBlob.length>>>0), u32le(partsBlob.length>>>0), u16le(0) ]); return concat([ partsBlob, centralBlob, end ]); }
function colLetters(n){ var s=''; n++; while(n>0){ var m=(n-1)%26; s=String.fromCharCode(65+m)+s; n=Math.floor((n-1)/26); } return s; }
function buildSheetXml(matrix){
  var rows=[],r,c,cells,v,ref;
  for(r=0;r<matrix.length;r++){
    cells=[];
    for(c=0;c<matrix[r].length;c++){
      v=matrix[r][c]; ref=colLetters(c)+(r+1);
      if(v===null||v===undefined||v===''){ continue; }
      if(typeof v==='number'){ cells.push('<c r="'+ref+'"><v>'+String(v)+'</v></c>'); }
      else { cells.push('<c r="'+ref+'" t="inlineStr"><is><t>'+xmlEscape(String(v))+'</t></is></c>'); }
    }
    rows.push('<row r="'+(r+1)+'">'+cells.join('')+'</row>');
  }
  return '<?xml version="1.0" encoding="UTF-8"?>\n<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"><sheetData>'+rows.join('')+'</sheetData></worksheet>';
}
function buildWorkbookXml(){ return '<?xml version="1.0" encoding="UTF-8"?>\n<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><sheets><sheet name="Tunnit" sheetId="1" r:id="rId1"/></sheets></workbook>'; }
function buildWorkbookRels(){ return '<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/></Relationships>'; }
function buildRootRels(){ return '<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/></Relationships>'; }
function buildContentTypes(){ return '<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/><Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/></Types>'; }

async function exportXLSX(){
  try{
    var items = load(storeKey) || [];
    var toExport=[], ids=[], i;
    for(i=0;i<items.length;i++){ if(!items[i].exported_at){ toExport.push(items[i]); ids.push(items[i].id); } }
    if(!toExport.length){ alert('Ei uusia vientejä'); return; }

    // Vie tiedostoon KAIKKI (aiemmin viedyt + uudet)
    var already = items.filter(function(x){ return !!x.exported_at; });
    var allForFile = already.concat(toExport);
    allForFile.sort(function(a,b){ return String(a.date).localeCompare(String(b.date)); });

    // --- HUOMIO lisätty kolmantena sarakkeena ---
    var data = [['Päivämäärä','Asiakas','Huomio','Työntekijä1','Tunnit1','Kirjattu1_pvm','Työntekijä2','Tunnit2','Kirjattu2_pvm','Yhteensä']];
    for(i=0;i<allForFile.length;i++){
      var it=allForFile[i];
      var h1 = it.hours1!=null ? it.hours1 : (it.hours!=null ? it.hours : null);
      var h2 = it.hours2!=null ? it.hours2 : null;
      var total=(h1||0)+(h2||0);
      data.push([
        it.date,
        it.customer||'',
        it.note||'',                 // ← HUOMIO SARAKE
        it.emp1||'',
        h1!=null?Number(h1):'',
        it.logged1_at||'',
        it.emp2||'',
        h2!=null?Number(h2):'',
        it.logged2_at||'',
        (total?Number(total):'')
      ]);
    }

    var files = [
      {name:'[Content_Types].xml', data:utf8enc(buildContentTypes())},
      {name:'_rels/.rels', data:utf8enc(buildRootRels())},
      {name:'xl/workbook.xml', data:utf8enc(buildWorkbookXml())},
      {name:'xl/_rels/workbook.xml.rels', data:utf8enc(buildWorkbookRels())},
      {name:'xl/worksheets/sheet1.xml', data:utf8enc(buildSheetXml(data))}
    ];
    var zipBytes = makeZip(files);
    var blob = new Blob([zipBytes], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});

    var saved=false;
    try{
      if('showSaveFilePicker' in window){
        if(!window.__tuntiHandle){
          window.__tuntiHandle = await window.showSaveFilePicker({
            suggestedName:'Tunnit.xlsx',
            types:[{description:'Excel-työkirja', accept:{'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx']}}]
          });
        }
        var w = await window.__tuntiHandle.createWritable();
        await w.write(blob);
        await w.close();
        saved = true;
        setDebug('Tallennettu tiedostoon: Tunnit.xlsx');
      }
    }catch(e){}

    if(!saved){
      var a=document.createElement('a'); var url=URL.createObjectURL(blob);
      a.href=url; a.download='Tunnit.xlsx'; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(function(){ URL.revokeObjectURL(url); }, 1200);
      setDebug('Lataus: Tunnit.xlsx');
    }

    var stamp=todayStr();
    for(i=0;i<items.length;i++){ if(ids.indexOf(items[i].id)!==-1){ items[i].exported_at=stamp; } }
    save(storeKey, items);
    alert('Vienti valmis.');
  }catch(e){ alert('Vienti epäonnistui: '+e); }
}

/* ===== Käynnistys ===== */
function attach(){
  $('date').value = todayStr();
  fillDatalists();
  setButtons();
  updateTimerView();

  $('startBtn').addEventListener('click', start);
  $('pauseBtn').addEventListener('click', pause);
  $('resumeBtn').addEventListener('click', resumeTimer);
  $('stopBtn').addEventListener('click', stopAndSave);
  $('exportXlsxBtn').addEventListener('click', exportXLSX);
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', attach); } else { attach(); }
window.addEventListener('error', function(e){ setDebug('Virhe: ' + (e && e.message ? e.message : e)); });

/* Päivitä napit tilan mukaan realtime */
const obs = new MutationObserver(()=>{ /* no-op */ });
setInterval(()=>{
  // sync nappien tilat
  document.getElementById('pauseBtn').disabled  = !running || paused;
  document.getElementById('resumeBtn').disabled = !running || !paused;
  document.getElementById('stopBtn').disabled   = !running;
}, 300);
</script>
<script>
/* ===== Portaalin teema: luku & live-päivitys (kaikki muut sivut) ===== */
(function applySavedTheme(){
  const THEME_KEY='portal_theme_v1';
  function apply(vars){
    const root=document.documentElement;
    if(!vars) return;
    for(const k in vars){ root.style.setProperty(k, vars[k]); }
    root.style.setProperty('--bg',  vars['--bg']  || '#fff');
    root.style.setProperty('--text',vars['--text']|| '#111');
  }
  try{
    const saved = JSON.parse(localStorage.getItem(THEME_KEY) || 'null');
    if(saved) apply(saved);
  }catch(_){}

  // Päivitä live, jos väri muuttuu yrityksen-tiedot-sivulla
  window.addEventListener('storage', (e)=>{
    if(e.key===THEME_KEY || e.key==='__theme_ping'){
      try{ const t = JSON.parse(localStorage.getItem(THEME_KEY)||'null'); if(t) apply(t); }catch(_){}
    }
  });
})();
</script>
</body>
</html>